<html>
	<head>
		<meta http-equiv="Content-type" content="text/html; charset=utf-8"></meta>
    <link href="http://fonts.googleapis.com/css?family=Abril+Fatface|Open+Sans:300,400,600,700,800|Gentium+Book+Basic:400,400italic|Vollkorn:400italic,400" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=PT+Sans:700|Playfair+Display:400,900,700italic|Oswald:700|PT+Mono' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Merriweather:400,900&subset=latin-ext' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" media="screen" href="style.css" />
    <meta name="description" content="How James Somers reverse-engineered Google Docs to play back any document's keystrokes">
    <link rel="shortcut icon" href="http://jsomers.net/favicon.ico" />
     <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type="text/javascript" src="gif-player.js"></script>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5458727d16a5b612"></script>
    <link rel="alternate" type="application/rss+xml" 
    		  title="RSS Feed for jsomers.net" 
    		  href="http://jsomers.net/blog/feed" />
          
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no, width=device-width">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" media="(device-height: 568px)">

    <meta name="apple-mobile-web-app-title" content="James Somers (jsomers.net)">
    <title>How I reverse-engineered Google Docs to play back any document's keystrokes &laquo; James Somers (jsomers.net)</title>
    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-11997371-1', 'auto');
      ga('send', 'pageview');

    </script>
  </head>
  
  <body>
    <div id="title">
      <section class="text">
        <h1><span>How I<br></span> Reverse Engineered <br> Google Docs <br> <span class="smaller">To Play Back Any Document&#8217;s Keystrokes</span></h1>
        <h2><a href="http://jsomers.net">James Somers</a></h2>
      </section>
    </div>
    
    <div id="container">
      <div class="time">November 5th, 2014</div>
      
      <div id="post">
        <p>If you&#8217;ve ever typed anything into a Google Doc, you can now play it back as if it were a movie &#8212; like traveling through time to look over your own shoulder as you write.</p>

        <p>This is possible because every document written in Google Docs since <a href="http://googledocs.blogspot.com/2010/05/whats-different-about-new-google-docs.html" target="_blank">about May 2010</a> has a revision history that tracks every change, by every user, with timestamps accurate to the microsecond; these histories are available to anyone with &#8220;Edit&#8221;
 permissions; and I have written a piece of software that can find, decode, and rebuild the history for any given document.</p>

        <hr/>
        
        <iframe width="100%" height="315" src="embed.html" frameborder="0" allowfullscreen></iframe>

        <p>See that little gizmo above? It&#8217;s like a video player, but made especially for writing. This one&#8217;s from an Atlantic article I began work on nearly four years ago, on the day after Christmas in 2010. The <a href="http://www.theatlantic.com/technology/archive/2011/01/why-learning-to-fly-or-code-is-easier-than-you-think/69324/" target="_blank">article</a> was about the first (and only) time I got to fly a small airplane. At the time, I didn&#8217;t give the slightest thought to the idea that one day I&#8217;d be able to watch the draft unfold. But since I happened to write this one in Google Docs, I can recover every keystroke. Above, you can see the first uncertain stirrings of the first paragraph.</p>

        <p>What&#8217;s neat about this is that I didn&#8217;t have to use any special software while I was writing to make this &#8220;video&#8221; possible. I was working in plain old vanilla Google Docs. And to show you this one paragraph I liked, I didn&#8217;t have to present you with the whole document (all 39,154 revisions of it) &#8212; I could extract bits and pieces that I thought were interesting, and interleave them in a blog post. Imagine what a high school English teacher could do with that. Imagine what you could do with that if instead of a minor effort by ol&#8217; Somers here you had, say, a piece by Ta-Nehisi Coates. (I&#8217;ve always wanted to watch how TNC writes. If he&#8217;s ever used Google Docs, it&#8217;s now possible.)</p>
        
        <a href="http://draftback.com" target="_blank">
          <div style="text-align: center; margin:0 auto; margin-bottom: 20px">
          	<img class="big-screenshot" src="https://cloud.githubusercontent.com/assets/21294/4896985/9f432084-6401-11e4-90db-96dc54cfe313.png"/>
          </div>
        </a>
        <p class="caption">A screenshot showing what it&#8217;s like to work with a document in <a href="http://draftback.com" target="_blank">Draftback</a>.</p>
        
        <p>To produce the embed, I used a website I made called <a href="http://draftback.com" target="_blank">draftback.com</a>, which I suppose I&#8217;m launching right now. With Draftback, you can play back and analyze any of your own Google Docs, or, for that matter, any Google Doc you have permission to edit.</p>

        <p>(Everyone I&#8217;ve talked to about this has been surprised, and maybe a little unnerved, to discover that whenever they share a Google Doc with someone, they&#8217;re <em>also</em> sharing an extremely detailed record of them typing the thing.)</p>

        <a href="https://cloud.githubusercontent.com/assets/21294/4883761/4361da54-6365-11e4-8b46-f67f4f9520b3.png" target="_blank">
          <div style="text-align: center; margin:0 auto; margin-bottom: 20px">
              <img class="graph bordered" src="https://cloud.githubusercontent.com/assets/21294/4883761/4361da54-6365-11e4-8b46-f67f4f9520b3.png" />
          </div>
        </a>
        <p class="caption">A map of changes to a document over time.</p>

        <p>Here&#8217;s a graph that Draftback automatically produced for an article I was working on a few weeks ago. It shows the timeline of my changes, and below it, a &#8220;map&#8221; that tells me where in the document each of those revisions happened: the further down the graph, the further down the page. At the start, I added many thousands of words of notes &mdash; that&#8217;s why the doc gets so long so fast, and why the edits look sparse. Then you can see that I made three distinct passes, the first one focused on the top of the article, and slow; and the later ones faster and further down. A visual fingerprint of a document, and of a writer.</p>

        <p>The data that Google stores is, as you might expect, kind of incredible. What we actually have is not just a coarse &#8220;video&#8221; of a document &#8212; we have the complete history of every single character. Draftback is aware of this history, and assigns each character a persistent unique ID, which makes it possible to do stuff that I don&#8217;t think folks have really done to a piece of writing before.</p>
        
      	<script type="text/javascript">
      		$(document).ready( function(){
      			$('.gif-player').each(function(){
      				var self = $(this);
      				this.gp = new gifPlayer(self, { autoplay: false });
      			});
      		});
      	</script>
        
        <div class=gif-player style="text-align: center; margin:0 auto; margin-bottom: 20px;">
        	<img class="bordered gif-still gif-ctrl gif-ctrl-p" src="https://cloud.githubusercontent.com/assets/21294/4896412/9d387422-63f9-11e4-888d-7f4d0d27f543.png">
        	<img class="bordered gif-movie"	gif="http://i.imgur.com/KRSaHEa.gif">
        </div>

        <p class="caption">This animation shows how knowing every character&#8217;s history can help you trace the origins of the text you highlight.</p>
        
        <p>Here, for instance, you can see me typing a short document. Focus on the first paragraph: you&#8217;ll see that it wasn&#8217;t written in one contiguous swoop, but rather was cobbled together over time via a bunch of discontinuous edits: I edit the paragraph, then do other stuff, then I come back to the paragraph, and so on. I even cut and paste a phrase from one paragraph to another.</p>

        <p>Since Draftback has the full history for every character, and since that history is maintained even as characters are cut and pasted, it&#8217;s possible to select some text and see exactly where it came from. It&#8217;s like having a four-dimensional view of a document.</p>
        <hr/>
        <h3>To what end?</h3>
        
        <p>I&#8217;ve long been obsessed by what you might call the &#8220;archaeology&#8221; of writing: how something like John McPhee&#8217;s profile of Bill Bradley (<a href="http://www.newyorker.com/magazine/1965/01/23/a-sense-of-where-you-are" target="_blank">A Sense of Where You Are</a>), or T. S. Eliot&#8217;s <a href="http://lit.genius.com/Ts-eliot-the-waste-land-annotated" target="_blank">The Waste Land,</a> comes to be.</p>

        <p>I&#8217;ll read stuff about it: <a href="http://muse.jhu.edu/journals/mod/summary/v012/12.1rainey.html" target="_blank">Eliot Among the Typists</a> is a fascinating paper; the <a href="http://books.google.com/books?id=8C0OoG5e12AC&amp;printsec=frontcover&amp;dq=the+john+mcphee+reader&amp;hl=en&amp;sa=X&amp;ei=a2n1U-7AIPLKsQT2kIHwCw&amp;ved=0CB4Q6AEwAA#v=onepage&amp;q=introduction&amp;f=false" target="_blank">introduction</a> to <a href="http://www.amazon.com/The-John-McPhee-Reader/dp/0374517193" target="_blank"><em>The John McPhee Reader</em></a> is good, as are McPhee&#8217;s own essays on writing, <a href="http://www.newyorker.com/magazine/2013/01/14/structure" target="_blank">Structure</a> and <a href="http://jsomers.net/mcphee-draft-no-4.pdf" target="_blank">Draft No. 4</a>. I liked McP&#8217;s <a href="http://www.theparisreview.org/interviews/5997/the-art-of-nonfiction-no-3-john-mcphee" target="_blank">interview</a> in The Paris Review, whose <a href="http://www.theparisreview.org/interviews" target="_blank">long-running series</a> is legendary, especially <a href="http://www.theparisreview.org/interviews/4825/the-art-of-fiction-no-21-ernest-hemingway" target="_blank">this one with Hemingway</a>, which is one of the best things I&#8217;ve read.</p>

        <p>But what if you could actually <em>see</em> these guys at work? Isn&#8217;t it a shame you can&#8217;t?</p>

        <p>I worry that most people aren&#8217;t as good writers as they should be. One thing is that they just <a href="http://jsomers.net/blog/more-people-should-write" target="_blank">don&#8217;t write enough</a>. Another is that they don&#8217;t realize it&#8217;s <a href="http://www.theatlantic.com/technology/archive/2011/07/composition-101-how-email-can-change-the-way-professors-teach/242468/" target="_blank">supposed to be hard</a>; they think that good writers are talented, when the truth is that good writers get good the way good programmers get good, the way good anythings get good: by <a href="http://meta.genius.com/4127095/Genius-the-genius-isms/Whenever-youre-deciding-what-to-do-next-pick-the-thing-you-least-want-to-do" target="_blank">running into the spike</a>. Maybe folks would understand that better if they had vivid evidence that a good writer actually spends most of his time fighting himself.</p>

        <p>That&#8217;s why I wanted something like Draftback. I had this image I just couldn&#8217;t shake: you&#8217;d get someone whose writing is accessible, concise, uncontroversial, well-styled, and, above all, quintessentially <em>writing:</em> i.e., someone who&#8217;s writing in a form where the writing is what there is, where the job isn&#8217;t to report but rather to put into words what we would think if only we had their critical equipment and verbal range&#8230; someone like A.O. Scott, who reviews movies for the New York Times and does such a good job of it that sometimes I&#8217;ll watch a movie just so I can read his review.</p>

        <p>So you get A.O. Scott to write in Google Docs, and you publish the full playback and excerpted bits and pieces of it, the greatest hits &#8212; annotated, of course, director&#8217;s-commentary style &#8212; for every fan, every aspiring writer, and every high school English teacher in the country.</p>

        <p>Whaddya say, Mr. Scott?</p>
        
        <hr>
        <h3>The Technical Origin Story: From Etherpad to Jimbopad to Google Docs</h3>

        <p>It all started 5 years ago on Hacker News with this oddly exuberant post by pg himself: <a href="https://news.ycombinator.com/item?id=495336" target="_blank">The most surprising thing I&#8217;ve seen in 2009, courtesy of Etherpad</a>. pg got famous because of his essays, and here you could watch him write one, backspaces and all. It was a sensation. At the time, it was one of the biggest Hacker News stories ever.</p>

        <p><a href="https://code.stypi.com/hacks/13sentences" target="_blank">Here&#8217;s what it looked like</a>. (This is actually a later, slightly more advanced version; the original, at etherpad.com, was taken down when Etherpad was bought by Google. More on that later.) All it was was a document with a slider at the top and a big play button, showing every revision. You could play the whole history start to finish. Prettty simple.</p>

        <p>I remember seeing this playback and thinking that it could be better. I wanted more information: when did pg pause, and for how long? How much, exactly, did he delete? How did that compare against other writers? What if I saw a sentence I really liked &#8212; could I trace it to its source?</p>

        <p>So I decided to build a thing I called JimboPad. I was surprised at how simple JimboPad turned out to be. You don&#8217;t actually need that much code to play back a record of someone writing. All you need is a textarea and some way of tracking diffs. <a href="http://jsomers.net/jimbopad/" target="_blank">Here&#8217;s what the playback UI was like</a>, and here&#8217;s the JavaScript that made it possible (click on the highlighted bits of code for annotations):</p>

        <div id='rg_embed_link_565954' class='rg_embed_link'>Read <a href="http://tech.genius.com/James-somers-code-sample-for-embed-annotated">“Code sample for embed” by James Somers</a> on Genius</div><script src='//tech.genius.com/songs/565954/embed.js?u=150586'></script>

        <p>Simple as it is, this was actually better for my purposes than Etherpad. The problem with Etherpad is that in order to power its playback feature, it actually stored a full snapshot of the document at every tick. So if you had a 1MB text file &#8212; say, you&#8217;re working on <a href="theatlantic.com/magazine/archive/2013/11/the-man-who-would-teach-machines-to-think/309529/" target="_blank">a 7,500-word article</a> &#8212; every keystroke would dump another meg on disk. Jimbopad, which was purpose-built for playback &#8212; I didn&#8217;t have to worry about real-time collaboration, which was Etherpad&#8217;s raison d&#8217;être and big value proposition &#8212; just stored &#8220;deltas&#8221; between each revision, which led to about a 1,000x decrease in required storage.</p>

        <blockquote>This is why if you were to do “version control” for writing, you would have to record everything. You would have to make it trivial for the writer to “branch” off from some articulation, fail, and fall back to what they had before. Their every half-overture would have to be saved—because every half-overture, like every “commit,” might have words they would want to get back to. <p>— <a href="http://jsomers.net/blog/jimbopad" target="_blank">jsomers.net/blog/jimbopad</a></p>
        </blockquote>

        <p>As soon as I made jimboPad, which was the simplest this program could possibly be, I wanted something better. That&#8217;s when I set out to build Draftback 1.0. Here&#8217;s an example:</p>

        <p><a href="http://jimbopad.herokuapp.com/drafts/1/underlining/playback" target="_blank">http://jimbopad.herokuapp.com/drafts/1/underlining/playback</a></p>

        <p>As far as I can tell this was the state of the art in writing playback. You&#8217;ve got your slider, of course. But you&#8217;ve also got these nifty green and red colors that show you exactly what changed in each revision. You&#8217;re automatically scrolled to the part of the document that changed (HUGE innovation). And you could drop in to &#8220;actual-speed&#8221; playback mode, which somehow I thought was far more intimate, and interesting, than watching a ceaseless robotic clack. (It had a feature where if the delay between revisions was long enough, a thing would come up and say &#8220;the writer stared into space for 30 minutes&#8221; or whatever.) You could even search phrases and filter to just the revisions including that phrase.</p>

        <p>But there were still a bunch of problems. The &#8220;search&#8221; filter was really naïve: all it did was look for all revisions whose full rendered text included the phrase, and filtered out everything else. That&#8217;s useful, but what I was really looking for was the &#8220;origin story&#8221; of a phrase or sentence; I wanted to know where the <em>parts</em> of the sentence, before it was the atomic unit I&#8217;m seeing now, came from. That just wasn&#8217;t even possible using the diff-match-patch approach.</p>

        <p>Maybe the bigger problem was that no good writer was going to use this program. Up to this point, my &#8220;editor&#8221; had been a simple textarea, and I was requiring that you write in Markdown. And eventually I got this mantra in my head: &#8220;AO Scott is never gonna use markdown&#8221;, &#8220;AO Scott is never gonna use markdown.&#8221;</p>

        <p>I was convinced you needed a beautiful clean WYSIWYG editor to get people to use your writing software.</p>

        <p>I looked at a lot of options, and ultimately I paid for a thing called <a href="http://imperavi.com/redactor/docs/api/" target="_blank">Redactor</a>. That&#8217;s right: in my desperation I actually <em>bought</em> my RTF technology. I paid like $200 for a Javascript file.</p>

        <p>Redactor was actually a good editor, it had this great big API, it was really easy to hack on, but still it ultimately used <code>content-editable</code>, and <code>content-editable</code> ends up breaking a lot. Here are a couple of TODOs and notes from my time working on that editor:</p>

        <ul>
          <li>The WYSYWIG control buttons sometimes don&#8217;t reflect state. Toggles don&#8217;t toggle properly.</li>
          <li>Why does hitting &#8220;I&#8221; italicize so much text?</li>
          <li>Does un-blockquoting something not return you to normal formatting?</li>
        </ul>

        <p>So that was a problem.</p>
        
        <hr>
        <h3>The § That Actually Finally Delivers What the Title Promised: An explanation of how to reverse-engineer Google Docs&#8217;s diff data structures and renderer, a system which was actually probably developed for real-time collaboration, a.k.a &#8220;Operational Transformation,&#8221;
 a.k.a. nothing to do with &#8220;the archaeology of writing&#8221;</h3>

        <p>The slam dunk in my face was <a href="http://googledocs.blogspot.com/2010/05/whats-different-about-new-google-docs.html" target="_blank">this blog post by Google</a> in which they explained why they scrapped the <code>content-editable</code> approach for Docs and built a brand new rendering engine from scratch.</p>

        <p>When you&#8217;re using Google Docs, you&#8217;re not actually typing into where you think you&#8217;re typing. You&#8217;re typing into a textarea in an iFrame off-screen, and through the postMessage API, those events are being sent to the &#8220;edit surface&#8221; that you see, which does stuff like draw your cursor. (Your cursor on Docs isn&#8217;t actually a cursor, it&#8217;s a 2px-wide <code>div</code>!)</p>

        <p>I took this as proof not just that I was never going to be able to build a good word processor with <code>content-editable</code>, but that Google were the only ones who had the gall, and technical wherewithal, to do the insane gymnastics required to build something that felt like Word in the browser. I figured if I couldn&#8217;t beat them, I&#8217;d join them: I&#8217;d write a jimboPad-like plugin or extension for Docs.</p>

        <hr/>

        <p>I started by trying to build an actual <a href="https://developers.google.com/apps-script/quickstart/docs" target="_blank">plugin</a> for Docs. I played with their sample code, I looked through the documentation. I was trying to see if there was a hook I could get that would tell me when a user changed the document. Because recall that all I really need is a hook, a diff-match-patch library, and a place to store the deltas, and that would be enough.</p>

        <pre>   &#8220;The onEdit trigger runs automatically when a user changes the value of
    any cell in a *spreadsheet*&#8221;</pre>

        <p>It turns out that they don&#8217;t expose this kind of event for their docs. And that&#8217;s when things started getting pretty interesting.</p>

        <p>I decide I&#8217;m just going to write a Chrome extension on top of Google Docs, and I&#8217;m gonna capture the rendered HTML every time I make a change. Sure, the user has to install a Chrome extension, but that&#8217;s pretty simple, and when they&#8217;re using Docs they&#8217;ll hardly notice that my extension is there. It&#8217;ll feel like a seamless transparent experience.</p>
        
        <a href="https://cloud.githubusercontent.com/assets/21294/4884191/3da89c34-6369-11e4-9cbe-c5e03695ae4d.png" target="_blank">
          <div style="text-align: center; margin:0 auto; margin-bottom: 20px">
          	<img class="bordered inspector-1" src="https://cloud.githubusercontent.com/assets/21294/4884191/3da89c34-6369-11e4-9cbe-c5e03695ae4d.png"/>
          </div>
        </a>
        
        <p>So what I did was I looked in the web inspector and found the DOM I cared about. I found out that all the actual content has these classes like <code>kix-page</code> and <code>kix-lineview</code> and <code>kix-wordhtmlgenerator-word-node</code>. (Google&#8217;s codename for their Docs edit surface and rendering engine is &#8220;Kix.&#8221;) I figured that I could do something like this in a Chrome extension:</p>


        <div id='rg_embed_link_566001' class='rg_embed_link'>Read <a href="http://tech.genius.com/James-somers-chrome-extension-to-capture-google-docs-revisions-annotated">“Chrome extension to capture Google Docs revisions” by James Somers</a> on Genius</div><script src='//tech.genius.com/songs/566001/embed.js?u=150586'></script>

        <p>I thought I was pretty clever, but while testing this code, I discovered that sometimes it would miss big chunks of my document. I found out that Google renders pages on demand: if you load a 99-page document, although it might <em>look</em> like you can scroll all the way down, right away, the actual text on those later pages won&#8217;t be generated until you scroll it into view.</p>

        <p>At this point I did something kinda dumb. I tried to reverse-engineer the client-side editor code so that I could find whatever the render function was. I figured if I could find <em>some</em> hook, I could trick the editor into thinking I&#8217;d scrolled through the whole document. That way my diff-match-patch tool would be working with the full document at each revision.</p>

        <p>My thought was that if the Docs editor/rendering code was all Javascript, I must be able to figure out how it works, even if it was 80,000 lines of code that looked like this:</p>


        <div id='rg_embed_link_566012' class='rg_embed_link'>Read <a href="http://tech.genius.com/James-somers-obfuscated-kix-renderer-code-annotated">“Obfuscated Kix renderer code” by James Somers</a> on Genius</div><script src='//tech.genius.com/songs/566012/embed.js?u=150586'></script>

        <p>I tried to do this by throwing breakpoints all over the place. I&#8217;d search for phrases in the code that weren&#8217;t obfuscaed, like <code>innerHTML</code>, and throw a breakpoint beside them. Then I&#8217;d do stuff in the UI, and see if I hit my breakpoint. Then I&#8217;d inspect the call stack and see what values were lying around. I found out stuff like if you type something like <code>P.j.zb.rx()</code> in the console, and run it, you&#8217;ll &#8220;redo&#8221; whatever your last action was. I spent days doing this. In fact, on one weekend I spent so much time staring at minified Docs Javascript that I literally developed an eye ulcer. </p>

        <p>Have you ever heard the story of how while NASA spent years and tens of millions of dollars developing a pen that would write in space, underwater, and upside-down, the Russians just brought a pencil? It&#8217;s apparently not true (the space pen <em>was</em> much safer than a pencil, and Russians wanted one too) but it illustrates a point. Here&#8217;s the &#8220;Russians bring a pencil&#8221; solution to my rendering problem. Again, click the highlighted lines to see an annotation that explains what&#8217;s going on:</p>


        <div id='rg_embed_link_566016' class='rg_embed_link'>Read <a href="http://tech.genius.com/James-somers-the-russians-brought-a-pencil-solution-annotated">“The "Russians Brought a Pencil" Solution” by James Somers</a> on Genius</div><script src='//tech.genius.com/songs/566016/embed.js?u=150586'></script>

        <p>Needless to say, I wasn&#8217;t really happy with this solution. And I had seen something curious while getting my eye ulcer. At one point I&#8217;d clicked away from the &#8220;Sources&#8221; tab in the Chrome inspector and started looking at the &#8220;Network&#8221; tab. And I noticed these &#8220;/save&#8221; calls every time I typed something:</p>

        <a href="https://cloud.githubusercontent.com/assets/21294/4884332/ba8f6a60-636a-11e4-8a1e-a2b4872e86c0.png" target="_blank">
          <div style="text-align: center; margin:0 auto; margin-bottom: 20px">
          	<img class="bordered" src="https://cloud.githubusercontent.com/assets/21294/4884332/ba8f6a60-636a-11e4-8a1e-a2b4872e86c0.png"/>
          </div>
        </a>
        
        <p>The payload looked pretty juicy. Here, for instance, I&#8217;m typing a period at the end of a sentence early in the document:</p>
        
        <a href="https://cloud.githubusercontent.com/assets/21294/4884351/f1a9d4ea-636a-11e4-99a1-195a8354306d.png" target="_blank">
          <div style="text-align: center; margin:0 auto; margin-bottom: 20px">
          	<img class="bordered" src="https://cloud.githubusercontent.com/assets/21294/4884351/f1a9d4ea-636a-11e4-99a1-195a8354306d.png"/>
          </div>
        </a>
        
        <p>That seems parseable enough: a &#8220;command&#8221; of type (<code>ty</code>) insert (<code>is</code>) where the &#8220;insert begin index&#8221; (<code>ibi</code>) is 24 and the string (<code>s</code>) is &#8220;.&#8221;. Now we&#8217;re cooking with gas.</p>

        <p>At this point, I figured my Chrome extension could be pretty dumb. All I had to do was intercept these &#8220;save&#8221; requests and store them somewhere. Later, I could figure out how to use them to rebuild the document. As long as someone had my extension installed from the very start of their editing, and never made any change in a browser <em>without</em> the extension, I should have enough to do everything Docs could do. (I reasoned that Docs gets exactly no more data about a document than what is sent to the server via these &#8220;save&#8221; calls; so those <em>must</em> be enough to render everything.)</p>

        <p>Here&#8217;s what I cooked up:</p>

        <div id='rg_embed_link_566022' class='rg_embed_link'>Read <a href="http://tech.genius.com/James-somers-chrome-extension-redux-this-time-with-request-captures-annotated">“Chrome Extension Redux, This Time With Request Captures” by James Somers</a> on Genius</div><script src='//tech.genius.com/songs/566022/embed.js?u=150586'></script>

        <p>This gave me a bunch of commands that looked like this:</p>

        <div id='rg_embed_link_566026' class='rg_embed_link'>Read <a href="http://tech.genius.com/James-somers-google-docs-data-structure-annotated">“Google Docs Data Structure” by James Somers</a> on Genius</div><script src='//tech.genius.com/songs/566026/embed.js?u=150586'></script>

        <p>These didn&#8217;t seem so hard to figure out. You have what looks like a &#8220;multi&#8221; or bundle operation, and then inside of it, a list of other operations: some inserts and some deletes. For inserts, you have the string you&#8217;re adding; for deletes, the indexes that tell you what to remove. I built myself a debugging tool that would let me step through a list of these revisions, to see both a rendered document and a dump of the critical <code>characters</code> array I was using to represent it under the hood:</p>

        <a href="https://cloud.githubusercontent.com/assets/21294/4884411/911de89a-636b-11e4-8184-1f28eba9f5ee.png" target="_blank">
          <div style="text-align: center; margin:0 auto; margin-bottom: 20px">
          	<img class="bordered" src="https://cloud.githubusercontent.com/assets/21294/4884411/911de89a-636b-11e4-8184-1f28eba9f5ee.png"/>
          </div>
        </a>
        
        <p>The data is so simple that it almost suggests the implementation of the builder and renderer. You have a <code>characters</code> array, and you insert and remove characters from it. When you format text, you&#8217;re just passing a hash of options to a range of characters. The whole of my document builder looks like this, in outline. The main thing it&#8217;s doing, really, is giving intelligible names to a bunch of variables:</p>

        <div id='rg_embed_link_566032' class='rg_embed_link'>Read <a href="http://tech.genius.com/James-somers-basic-renderer-annotated">“Basic Renderer” by James Somers</a> on Genius</div><script src='//tech.genius.com/songs/566032/embed.js?u=150586'></script>
        
        <p>The renderer is also pretty simple. (For bigger documents, for now, I don&#8217;t render styles, because it&#8217;s a lot of extra work for not that much better of a user experience.) It works like this:</p>

        <div id='rg_embed_link_566037' class='rg_embed_link'>Read <a href="http://tech.genius.com/James-somers-basic-renderer-code-annotated">“Basic Renderer Code” by James Somers</a> on Genius</div><script src='//tech.genius.com/songs/566037/embed.js?u=150586'></script>
        
        <p>We have two levels: paragraphs and spans. To figure out what to wrap in styles, we look at each character and say &#8220;what are your calculated styles?&#8221; based on your hash of properties. Then we say &#8220;are those styles equal to the styles of the character before you?&#8221; If they are, we continue the span. If not, we create a new span.</p>

        <p>And that&#8217;s essentially all you need to make something like Draftback.</p>

        <p><em>Except</em>, of course, the big key, which is that wouldn&#8217;t it be nice if you didn&#8217;t have to install a Chrome extension to capture these &#8220;/save&#8221; requests?</p>

        <p>I was talking to my <a href="http://genius.com/lemon" target="_blank">boss</a> at <a href="http://genius.com" target="_blank">Genius</a> about this, and he suggested I look at the standard &#8220;Revision History&#8221; menu in Docs &#8212; maybe they had all the diffs somewhere in there?</p>

        <p>I thought he must be wrong, since I remembered that Google only ever rendered a fairly coarse set of changes: maybe dozens or at most a hundred revisions for a document that had probably been changed 10 or 100 times more than that. But I indulged the idea, and started poking around the Network tab while poking through the Revision History menu. It&#8217;s then that I chanced upon the <code>/load</code> call. It has a URL that looks like this:</p>

        <p><code>https://docs.google.com/document/d/#{docid}/revisions/load?id=#{docid}&amp;start=1330&amp;end=1341</code></p>

        <p>And it returns something that looks like this:</p>
        
        <a href="https://cloud.githubusercontent.com/assets/21294/4884576/0abb5d1c-636d-11e4-8464-06c16020ed3b.png" target="_blank">
          <div style="text-align: center; margin:0 auto; margin-bottom: 20px">
          	<img class="changelog bordered" src="https://cloud.githubusercontent.com/assets/21294/4884576/0abb5d1c-636d-11e4-8464-06c16020ed3b.png"/>
          </div>
        </a>
        
        <p>Hmm, I wonder what happens when you change the <code>start</code> and <code>end</code> parameters to cover a wider range? Will you, by chance, get the entire revision history for the document?</p>

        <p>I think yes.</p>

        <iframe src="//player.vimeo.com/video/9848524" width="100%" height="450" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe> <p class="caption"><a href="http://vimeo.com/9848524">Hack the planet</a> from <a href="http://vimeo.com/user2056851" target="_blank">James Somers</a> on <a href="https://vimeo.com" target="_blank">Vimeo</a>.</p>

        <p>There are a couple of complications &#8212; one is that you can&#8217;t just say &#8220;load me revisions 1 to infinity&#8221; (or -1): you have to specify the actual upper bound. My first cut at this was to do a <a href="http://rosettacode.org/wiki/Binary_search#Ruby">binary search</a> &#8212; if you get a <code>500</code> response, you know you&#8217;ve gone too high, so reduce your upper bound; if you get a <code>200</code>, you&#8217;re in range, so increase your lower bound; stop until lower > upper.</p>

        <p>And, of course, there&#8217;s the matter of building a renderer that works at scale, including for documents that have many tens of thousands of revisions, where each revision is hundreds of pages long. (For that, the main trick is in calculating a &#8220;window&#8221; around the locus of each revision, and only doing your heavy-duty rendering within that window.) And making a UI that people want to use. And finding a way to hit these undocumented APIs on the behalf of other Google users without having them give you their credentials.</p>

        <h3>A historical note</h3>

        <p>It&#8217;s worth noting for a second that Google probably wasn&#8217;t thinking of playback when they built this system for storing documents as a series of minute changes. They probably did it for the same reason that Etherpad did it, which is to power real-time collaboration. The only way you can do that quickly and reliably is by shooting small changes back and forth across the network; if two changes differ, you can just reject one of them, thereby ensuring that everyone has the same version of the document. This is a technique called <a href="http://en.wikipedia.org/wiki/Operational_transformation" target="_blank">operational transformation</a>, and it&#8217;s a whole science unto itself.</p>

        <p>So it&#8217;s not likely that Google is going to change the way they save documents just because it enables this playback stuff. The playback is an epiphenomenon of real-time collaboration, as it was with Etherpad. Etherpad made their playback demo at Paul Graham&#8217;s request; it was easy, since they were storing all this data anyway &#8212; because they had to. In fact, I think it&#8217;s possible that the very same engineers who built Etherpad found their way to the Docs team. (When they were acquired, they started at Wave, but then, of course, Wave was discontinued.)</p>

        <h3>A few notes about Draftback</h3>

        <p>In the spirit of <a href="http://firstround.com/article/rap-genius-explains-why-worse-is-better" target="_blank">&#8220;worse is better,&#8221;</a> the software at <a href="http://draftback.com" target="_blank">draftback.com</a> is about as simple as I could bear releasing, and it might not do well under heavy load. I hope people find it useful. You probably could use it to look at the revision history of documents where you really have no business doing so &#8212; documents, for instance, shared with you by folks who didn&#8217;t know you&#8217;d be able to see their revision history. Don&#8217;t do that, obviously.</p>
        
        <p>Aside from that, well, I&#8217;m just excited that this thing finally exists.</p>
        
        <hr>

        <div class="meta-bottom">
          <h3>Who are you?</h3>
          
          <p itemscope itemtype="http://data-vocabulary.org/Person">
            <span itemprop="name">James Somers</span> is a <span itemprop="title">writer and programmer</span> based in <span itemprop="address" itemscope itemtype="http://data-vocabulary.org/Address">
              <span itemprop="locality">New York</span>, 
              <span itemprop="region">NY</span>. He works on the engineering team at <a href="http://genius.com" itemprop="url" target="_blank">Genius.com</a>.
            </span> Follow <a href="http://twitter.com/jsomers" target="_blank">@jsomers</a> for updates. Or <span id="contactme">contact me directly at <script type="text/javascript">
          //<![CDATA[
          <!--
          var x="function f(x){var i,o=\"\",l=x.length;for(i=0;i<l;i+=2) {if(i+1<l)o+=" +
          "x.charAt(i+1);try{o+=x.charAt(i);}catch(e){}}return o;}f(\"ufcnitnof x({)av" +
          " r,i=o\\\"\\\"o,=l.xelgnhtl,o=;lhwli(e.xhcraoCedtAl(1/)3=!63{)rt{y+xx=l;=+;" +
          "lc}tahce({)}}of(r=i-l;1>i0=i;--{)+ox=c.ahAr(t)i};erutnro s.buts(r,0lo;)f}\\" +
          "\"(1),2\\\"\\\\`jgt!o)$$g'.#(03\\\\01\\\\%3FRM[04\\\\0r\\\\\\\\\\\\OJUGmI3i" +
          "uh77\\\\1t\\\\tmqy\\\"\\\\f(;} ornture;}))++(y)^(iAtdeCoarchx.e(odrChamCro." +
          "fngriSt+=;o27=1y%i;+=)y21==(iif){++;i<l;i=0(ior;fthnglex.l=\\\\,\\\\\\\"=\\" +
          "\",o iar{vy)x,f(n ioctun\\\"f)\")"                                           ;
          while(x=eval(x));
          //-->
          //]]>
          </script></span> <span id="mailme" style="display: none;"><script type="text/javascript">
          //<![CDATA[
          <!--
          var x="function f(x){var i,o=\"\",ol=x.length,l=ol;while(x.charCodeAt(l/13)!" +
          "=57){try{x+=x;l+=l;}catch(e){}}for(i=l-1;i>=0;i--){o+=x.charAt(i);}return o" +
          ".substr(0,ol);}f(\")9,\\\"]U_J@_100\\\\pb$0/9<*>2u1>r%3.:##(tk420\\\\e230\\" +
          "\\x!/6(4730\\\\430\\\\aQTY720\\\\T^WXSsACUBA^F120\\\\E]DNGH600\\\\771\\\\73" +
          "0\\\\GEmv=}'81v{sa}ae?dak`yhem\\\"(f};o nruter};))++y(^)i(tAedoCrahc.x(edoC" +
          "rahCmorf.gnirtS=+o;721=%y{)++i;l<i;0=i(rof;htgnel.x=l,\\\"\\\"=o,i rav{)y,x" +
          "(f noitcnuf\")"                                                              ;
          while(x=eval(x));
          //-->
          //]]>
          </script></span></p>
          
          <p>If you&#8217;d like to read more, check out <a href="http://jsomers.net/blog">jsomers.net/blog</a> or the list on my <a href="http://jsomers.net">homepage</a>. You can also subscribe for email updates below:</p>
          
          <script type="text/javascript">
          $(document).ready(function() {
            $("#email-signup-form").submit(function() {
              var emailval = $('input#email').val();

          if ($.trim(emailval) !== "") {
            $("input[name='subscribe']").replaceWith("<img src='/ajax-loader.gif'/>")
            $.ajax({
              url: 'http://jsomers.net/email_signup.php', // your url; on jsfiddle /echo/json/
              type: 'POST', // request method
              data: {
                email: emailval,
                b_1c70e701f700d17d3a360885e_642d8f1db8: $('input[name="b_1c70e701f700d17d3a360885e_642d8f1db8"]').val()
              },
              success: function(data) {
                $("#email_signup").replaceWith('<h4 style="margin-top: 20px; color: green;">' + data + '</h4>');
              }
            });
          } else {
              alert("Insert a email!");
          }
            return false;
            });
          });
          </script>
          
          <div id="email_signup">
            <form action="http://jsomers.net/email_signup.php" method="post" id="email-signup-form" name="email-signup-form" class="validate" target="_blank" novalidate style="padding-left: 0px; padding-bottom: 0px;">
              <input type="email" value="" name="email" class="email" id="email" placeholder="Enter your email address for updates" style="border: 2px solid #eee; padding: 5px; display: inline; margin-right: 0px; font-size: 13px; width: 250px;" required>
              <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
              <div style="position: absolute; left: -5000px;"><input type="text" name="b_1c70e701f700d17d3a360885e_642d8f1db8" value=""></div>
              <input type="submit" value="Sign up" name="subscribe" class="button" style="display: inline">
            </form>
          </div>
          
          <div id="mobile_email_signup">
            <a href="mailto:%6A%73%6F%6D%65%72%73@%67%6D%61%69%6C.%63%6f%6d?body=Hit%20send%20to%20get%20updates%20on%20my%20writing.&amp;subject=[jsomers.net%20mail%20subscription]%20I%27m%20in%21">Get my writing by email</a>
          </div>
          
          <h3>Acknowledgements</h3>

          <p>All errors, omissions, and lapses in judgement in the above are my own. The following people might not have known exactly how they were helping me or what with; they were just being their generous selves.</p>

          <p>I&#8217;d like to thank Jim for talking through diffs and nodes with me at length, and for explaining exactly the approach that it turned out Google uses, long before I discovered it. And Tom, for looking at what I thought was a pretty good demo and saying &#8220;well wouldn&#8217;t it be better if you could do this for <em>existing</em> documents,&#8221; and then coming up with a <a href="http://meta.genius.com/4127111">practical suggestion</a> for where to look. And finally to John, for letting me battle-test my code against his enormous, beautifully written book chapter.</p>
          
          <h3>Share this article</h3>
          
          <!-- Go to www.addthis.com/dashboard to customize your tools -->
          <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5458727d16a5b612" async="async"></script>
          
          <!-- Go to www.addthis.com/dashboard to customize your tools -->
          <div class="addthis_native_toolbox"></div>
        </div>
      </div>
    </div>
  </body>
</html>